# Интеграция на выдачу автомобилей

Этот раздел содержит описание команд для интеграции между серверами операторов каршерингов.
Все действия API интеграции должны выполняться с ключём, передаваемом в параметре apikey.

## Получение данных автомобилей

### Запрос списка автомобилей

    GET /api/integration/cars?apikey=1234567890

```josn
{
  "cars": [
    {
      "id": "8a6cddfe-4616-4d0c-9e1b-a8107065d1a8",
      "carModel": {
        "id": "8dd8c1e2-d9d3-4a6f-a6ae-a810204a998f",
        "carModel": "SsangYoung Kyron",
        "transmissionType": "Manual",
        "imageUrl": "http://test.cartrek.online/CarModel/Image/8dac9c9d-e014-4098-b084-a810006a998a"
      },
      "color": "белый",
      "fuelLevel": null,
      "isAvailableForRent": true,
      "isLocked": true,
      "isOnline": true,
      "lat": 57.0,
      "lon": 37.0,
      "regNumber": "A000AA000"
    }
  ]
}
```

### Запрос состояния автомобиля

    GET /api/integration/car/state?apikey=1234567890&carId=29686ea2-a698-45eb-95df-a77601614e44

```json
{
  "car": {
    "id": "29686ea2-a698-45eb-95df-a77601614e44",
    "carModel": {
      "id": "8dd8c1e2-d9d3-4a6f-a6ae-a810204a998f",
      "model": "Solaris",
      "transmissionType": "Automatic",
      "imageUrl": "http://test.cartrek.online/CarModel/Image/e5f038bd-8cfa-46a2-af5c-a70d014caa88"
    },
    "color": "Синий",
    "fuelLevel": null,
    "isAvailable": true,
    "isOnline": false,
    "lat": null,
    "lon": null,
    "regNumber": "A000AA000"
  }
}
```

## Управление арендой клиента

В отличие от команд упраления автомобилем, действия из этого раздела API обрабатываются логикой - проверка завершения аренды в зоне, проверка состояния ручного тормоза и фар при завершении аренды и т.д.

Параметры команд управления арендой:
```
    userId - идентификатор пользователя в вашей системе;
    carId - идентификатор автомобиля в нашей системе;
    customersLat - географическая широта смартфона клиента в момент выполнения команды;
    customersLon - географическая долгота смартфона клиента в момент выполнения команды.
```

Идентификатор userId может быть любой строкой. Если пользователь с таким идентификатором не найден, он будет создан.

#### Бронирование автомобиля (создание заказа):

    POST /api/integration/order/book?apikey=1234567890
    &carId=29686ea2-a698-45eb-97df-a776016d4e44
    &userId=SomeIdInYourSystem
    &customersLat=57.0&customersLon=37.0

#### Перевод заказа в режим использования

Переводит заказ в режим использования, отключает иммобиолайзер и открывает автомобиль.

    POST /api/integration/order/rent?apikey=1234567890&userId=SomeIdInYourSystem
    &customersLat=57.0&customersLon=37.0

#### Перевод заказа в режим парковки

Переводит заказ в режим парковки, включает иммобилайзер и закрывает автомобиль.

    POST /api/integration/order/park?apikey=1234567890&userId=SomeIdInYourSystem
    &customersLat=57.0&customersLon=37.0

#### Завершение заказа

Завершает заказ, включает иммобилайзер и закрывает автомобиль.

    POST /api/integration/order/finishRent?apikey=1234567890&userId=SomeIdInYourSystem
    &customersLat=57.0&customersLon=37.0

#### Активация сигнала автомобиля

Активирует сигнал автомобиля.

    POST /api/integration/order/horn?apikey=1234567890&userId=SomeIdInYourSystem
    &customersLat=57.0&customersLon=37.0

Ответы команд управления арендой унифицированные и содержат признак успешности выполнения, код ошибки и сообщение для пользователя (локализуемое):
```json
{
    "userMessage": "Машина успешно забронирована.",
    "code": 0,
    "isSuccess": true
}
```

## Управление состоянием автомобиля

Команды из этого раздела выполняются без учёта логики заказа и прочей бизнес-логики. Эти команды предназначены для использования операторами, например, для принудительного завершения аренды вне разрешённой зоны.

#### Закрыть центральный замок автомобиля

Закрывает центральный замок автомобиля.

    POST /api/integration/car/lock?apikey=1234567890&carId=29686ea2-a698-45eb-95df-a77601614e44

#### Открыть центральный замок автомобиля

Открывает центральный замок автомобиля.

    POST /api/integration/car/unlock?apikey=1234567890&carId=29686ea2-a698-45eb-95df-a77601614e44

#### Перевод в режим парковки

Принудительно переводит автомобиль в режим парковки (если есть активная аренда).

    POST /api/integration/car/park?apikey=1234567890&carId=29686ea2-a698-45eb-95df-a77601614e44

#### Перевод в режим использования

Принудительно переводит автомобиль в режим использования (если есть активная аренда).

    POST /api/integration/car/rent?apikey=1234567890&carId=29686ea2-a698-45eb-95df-a77601614e44

#### Завершение заказа

Принудительно завершает аренду автомобиля (если есть активная аренда).

    POST /api/integration/car/finishRent?apikey=1234567890&carId=29686ea2-a698-45eb-95df-a77601614e44

#### Активация сигнала автомобиля

Активирует сигнал автомобиля без учёта ограничений на расстояние до автомобиля и частоту активаций сигнала.

    POST /api/integration/car/horn?apikey=1234567890&carId=29686ea2-a698-45eb-95df-a77601614e44

#### Блокировка автомобиля

Активирует иммобилайзер автомобиля.

    POST /api/integration/car/immobilize?apikey=1234567890&carId=29686ea2-a698-45eb-95df-a77601614e44

#### Разблокировка автомобиля

Деактивирует иммобилайзер автомобиля.

    POST /api/integration/car/mobilize?apikey=1234567890&carId=29686ea2-a698-45eb-95df-a77601614e44

# Методы работы с клиентами
В этом разделе собраны методы API, предназначенные для работы с базой данных клиентов.

#### Отправка сообщения клиенту
Отправляет клиенту текстовое сообщение. Сообщение может быть отправлено либо с помощью SMS, либо Push. Возможна отправка сообщения на языке клиента.

    POST /api/integration/customer/send/message?apikey=1234567890&email=test@example.com&phoneNumber=+70000000000&userId=GUID&usePush=true&useSms=true&message=[Текст сообщения]&title=[Текст заголовка пуша]&popupUrl=[url]
    
Параметры email, phoneNumber, userId альтернативные. Один из них должен присутствовать обязательно.

Если оба параметра usePush и useSms равны true, то система сначала попытается отправить пуш, а если доставить сообщение не удалось, через некоторое время будет отправлено SMS.

Параметр title необязательный. Если его не передать, в заголовке пуша будет просто название приложения.

Если задан необязательный параметр popupUrl, в приложении пользователя будет показано окно с WebView со страницей по адресу popupUrl.

Чтобы отправить сообщение на языке пользователя, в тело POST необходимо передать структуру вида
    
    {
        "Title":{
            "Translations": {
                    "en": "Title text",
                    "ru": "Текст заголовка"
                  }
          },
          "Message": {
            "Translations": {
                    "en": "Message text",
                    "ru": "Текст сообщения"
                  }
          },
          "PopupUrl": {
            "Translations": {
                    "en": "https://example.com/popup/en.html",
                    "ru": "https://example.com/popup/ru.html"
                  }
          }
    }
    
При этом нужно обязательно передать заголовок
    
    Content-Type: aplication/json

Из параметров message, title и popupUrl будут проигнорированы те, для которых в теле запроса есть хотя бы один перевод.

Если язык пользователя отличается от всех, переданных в теле POST, то по умолчанию используется английский. Если язык en не задан в сообщении, будет использован первый из заданных.